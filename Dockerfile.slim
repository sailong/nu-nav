# --------------------------------------------------------
# Stage 1: Build Frontend
# --------------------------------------------------------
FROM public.ecr.aws/docker/library/node:20-alpine AS frontend-builder
WORKDIR /app/frontend
# 利用缓存：先拷贝 package 文件安装依赖
COPY frontend/package*.json ./
RUN npm ci
# 拷贝源码并构建
COPY frontend/ .
RUN npm run build

# --------------------------------------------------------
# Stage 2: Build Backend Dependencies
# --------------------------------------------------------
FROM public.ecr.aws/docker/library/node:20-alpine AS backend-builder
WORKDIR /app/backend
COPY backend/package*.json ./
# 只安装生产环境依赖，极大减小体积
RUN npm ci --omit=dev

# --------------------------------------------------------
# Stage 3: Final Minimal Image
# --------------------------------------------------------
FROM public.ecr.aws/docker/library/node:20-alpine

# 安装 OpenSSL 以支持 Prisma Client
RUN apk add --no-cache openssl

WORKDIR /app

# 设置环境变量
ENV NODE_ENV=production
ENV PORT=80

# 1. 拷贝后端代码 (不包含 node_modules)
COPY backend/package*.json ./backend/
COPY backend/prisma ./backend/prisma/
COPY backend/routes ./backend/routes/
COPY backend/middleware ./backend/middleware/
COPY backend/index.js ./backend/
COPY backend/seed.js ./backend/

# 2. 从 Stage 2 拷贝生产环境依赖 (排除 devDependencies)
COPY --from=backend-builder /app/backend/node_modules ./backend/node_modules

# 3. 从 Stage 1 拷贝前端构建产物
COPY --from=frontend-builder /app/frontend/dist ./frontend/dist

# 4. 生成 Prisma Client
WORKDIR /app/backend
RUN npx prisma generate

# 暴露端口
EXPOSE 80

# 启动命令：迁移 -> 种子数据 -> 启动 Node
CMD ["sh", "-c", "npx prisma migrate deploy && node seed.js && node index.js"]
